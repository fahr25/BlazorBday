@page "/shop/review"
@using BlazorBday.Models
@using BlazorBday.Services
@using BlazorBday.Repositories
@using BlazorBday.Data
@inject OrderStateService OrderState
@inject IOrderRepository OrderRepo
@inject MarketShopDbContext Db
@inject NavigationManager Nav
@rendermode InteractiveServer

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <StepIndicator CurrentStep="8" />

            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">Review Your Order</h3>
                </div>
                <div class="card-body">
                    <ErrorAlert ErrorMessage="@errorMessage" OnClear="@(() => errorMessage = null)" />

                    <!-- Order Summary -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Agency Information</h5>
                            <p><strong>Agency:</strong> @OrderState.AgencyName</p>
                            <p><strong>Code:</strong> @OrderState.ThreeLetterCode</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Points Summary</h5>
                            <p><strong>Total Points:</strong> @OrderState.PointsAssigned</p>
                            <p><strong>Points Used:</strong> @OrderState.PointsUsed</p>
                            <p><strong>Points Remaining:</strong> @OrderState.PointsRemaining</p>
                        </div>
                    </div>

                    <!-- Cart Items -->
                    <h5>Your Items</h5>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Product</th>
                                <th>Points</th>
                                <th>Qty</th>
                                <th>Subtotal</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in OrderState.Items)
                            {
                                <tr>
                                    <td>@item.CategoryName</td>
                                    <td>@item.ProductName</td>
                                    <td>@item.UnitPoints</td>
                                    <td>@item.Quantity</td>
                                    <td>@item.Subtotal</td>
                                    <td>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                @onclick="() => RemoveItem(item.ProductId)">
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                <td><strong>@OrderState.PointsUsed points</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Actions -->
                    <div class="d-grid gap-2">
                        <button type="button"
                                class="btn btn-success btn-lg"
                                @onclick="CompleteOrder"
                                disabled="@isProcessing">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Complete Order
                        </button>
                        <button type="button" class="btn btn-secondary" @onclick="ContinueShopping">
                            Continue Shopping
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string? errorMessage;
    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        await OrderState.InitializeAsync();

        // Prerequisite checks
        if (OrderState.AgencyId == null)
        {
            Nav.NavigateTo("/shop/agency");
            return;
        }

        if (!OrderState.CanSelectGifts)
        {
            Nav.NavigateTo("/shop/card");
            return;
        }

        if (OrderState.Items.Count == 0)
        {
            errorMessage = "Your cart is empty. Please add items before checking out.";
        }
    }

    private async Task RemoveItem(int productId)
    {
        try
        {
            await OrderState.RemoveItemAsync(productId);
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to remove item. Please try again.";
        }
    }

    private void ContinueShopping()
    {
        Nav.NavigateTo("/shop/gifts");
    }

    private async Task CompleteOrder()
    {
        isProcessing = true;
        errorMessage = null;

        try
        {
            // Validate order
            if (!OrderState.CanSelectGifts)
            {
                errorMessage = "You must select a card, book, and treat before checkout.";
                isProcessing = false;
                return;
            }

            if (OrderState.Items.Count == 0)
            {
                errorMessage = "Your cart is empty.";
                isProcessing = false;
                return;
            }

            // Create order
            await using var tx = await Db.Database.BeginTransactionAsync();

            var order = new Order
            {
                AgencyId = OrderState.AgencyId ?? 0,
                ChildDateOfBirth = OrderState.ChildDateOfBirth ?? DateTime.MinValue,
                ChildAge = OrderState.ChildAge,
                PointsAssigned = OrderState.PointsAssigned,
                PointsUsed = OrderState.PointsUsed,
                TotalItems = OrderState.Items.Sum(i => i.Quantity),
                Status = OrderStatus.Pending,
                CreatedAt = DateTime.UtcNow,
                Items = new List<OrderItem>()
            };

            // Add order items and update inventory
            foreach (var cartItem in OrderState.Items)
            {
                var product = await Db.Products.FindAsync(cartItem.ProductId);
                if (product == null)
                {
                    errorMessage = $"Product '{cartItem.ProductName}' not found.";
                    await tx.RollbackAsync();
                    isProcessing = false;
                    return;
                }

                if (product.Inventory < cartItem.Quantity)
                {
                    errorMessage = $"Insufficient inventory for '{product.Name}'.";
                    await tx.RollbackAsync();
                    isProcessing = false;
                    return;
                }

                // Add order item
                order.Items.Add(new OrderItem
                {
                    ProductId = product.Id,
                    ProductName = product.Name,
                    UnitPoints = product.Points,
                    Quantity = cartItem.Quantity,
                    SubtotalPoints = cartItem.Subtotal
                });

                // Decrement inventory
                product.Inventory -= cartItem.Quantity;
            }

            // Save order
            Db.Orders.Add(order);
            await Db.SaveChangesAsync();
            await tx.CommitAsync();

            // Clear order state
            await OrderState.ClearAsync();

            // Navigate to thank you page
            Nav.NavigateTo($"/shop/thankyou/{order.Id}");
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred during checkout: {ex.Message}";
            isProcessing = false;
        }
    }
}
