@page "/shop/thankyou/{OrderId:int}"
@using BlazorBday.Models
@using BlazorBday.Repositories
@using Microsoft.EntityFrameworkCore
@using BlazorBday.Data
@inject MarketShopDbContext Db
@inject NavigationManager Nav
@rendermode InteractiveServer

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            @if (isLoading)
            {
                <div class="text-center p-5">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading order details...</p>
                </div>
            }
            else if (order == null)
            {
                <div class="alert alert-danger">
                    <h4>Order Not Found</h4>
                    <p>We couldn't find your order. Please contact support if you believe this is an error.</p>
                    <button class="btn btn-primary" @onclick="GoHome">Return to Home</button>
                </div>
            }
            else
            {
                <div class="card shadow">
                    <div class="card-header bg-success text-white text-center">
                        <h2 class="mb-0">ðŸŽ‰ Thank You for Shopping! ðŸŽ‰</h2>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success text-center">
                            <h4>Your order has been successfully placed!</h4>
                            <p class="mb-0">Order #@order.Id</p>
                        </div>

                        <!-- Order Details -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5>Order Information</h5>
                                <p><strong>Agency:</strong> @order.Agency?.Name</p>
                                <p><strong>Order Date:</strong> @order.CreatedAt.ToLocalTime().ToString("MMMM dd, yyyy")</p>
                                <p><strong>Child Age:</strong> @order.ChildAge years</p>
                            </div>
                            <div class="col-md-6">
                                <h5>Points Summary</h5>
                                <p><strong>Points Assigned:</strong> @order.PointsAssigned</p>
                                <p><strong>Points Used:</strong> @order.PointsUsed</p>
                                <p><strong>Points Remaining:</strong> @(order.PointsAssigned - order.PointsUsed)</p>
                            </div>
                        </div>

                        <!-- Order Items -->
                        <h5>Your Items</h5>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Points</th>
                                    <th>Qty</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in order.Items)
                                {
                                    <tr>
                                        <td>@item.ProductName</td>
                                        <td>@item.UnitPoints</td>
                                        <td>@item.Quantity</td>
                                        <td>@item.SubtotalPoints</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                    <td><strong>@order.PointsUsed points</strong></td>
                                </tr>
                            </tfoot>
                        </table>

                        <div class="alert alert-info">
                            <h5>What's Next?</h5>
                            <p>Your items will be prepared for pickup. Please contact your agency for pickup details.</p>
                            <p class="mb-0">Thank you for participating in the Birthday Market program!</p>
                        </div>

                        <div class="d-grid mt-4">
                            <button class="btn btn-primary btn-lg" @onclick="GoHome">
                                Return to Home
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int OrderId { get; set; }

    private Order? order;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrderAsync();
    }

    private async Task LoadOrderAsync()
    {
        isLoading = true;

        try
        {
            order = await Db.Orders
                .Include(o => o.Agency)
                .Include(o => o.Items)
                .FirstOrDefaultAsync(o => o.Id == OrderId);
        }
        catch (Exception ex)
        {
            // Order not found or error loading
            order = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoHome()
    {
        Nav.NavigateTo("/");
    }
}
