@page "/shop/login"
@using BlazorBday.Models
@using BlazorBday.Services
@using BlazorBday.Repositories
@inject OrderStateService OrderState
@inject IAgencyRepository AgencyRepo
@inject NavigationManager Nav
@rendermode InteractiveServer

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <StepIndicator CurrentStep="1" />

            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Welcome to the Birthday Market!</h3>
                </div>
                <div class="card-body">
                    <p class="lead">Please select your agency and enter your unique 3-letter code to begin shopping.</p>

                    <ErrorAlert ErrorMessage="@errorMessage" OnClear="@(() => errorMessage = null)" />

                    <EditForm Model="@formModel" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label for="agencyId" class="form-label">Select Your Agency</label>
                            <InputSelect id="agencyId" @bind-Value="formModel.AgencyId" class="form-select" required>
                                <option value="">-- Select Agency --</option>
                                @foreach (var agency in agencies)
                                {
                                    <option value="@agency.Id">@agency.Name</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => formModel.AgencyId)" />
                        </div>

                        <div class="mb-3">
                            <label for="threeLetterCode" class="form-label">3-Letter Agency Code</label>
                            <InputText id="threeLetterCode"
                                       @bind-Value="formModel.ThreeLetterCode"
                                       class="form-control text-uppercase"
                                       maxlength="3"
                                       placeholder="ABC"
                                       required />
                            <small class="form-text text-muted">Enter the unique 3-letter code provided by your agency.</small>
                            <ValidationMessage For="@(() => formModel.ThreeLetterCode)" />
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" disabled="@isLoading">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Continue
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Agency> agencies = new();
    private AgencyFormModel formModel = new();
    private string? errorMessage;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await OrderState.InitializeAsync();
        await LoadAgenciesAsync();
    }

    private async Task LoadAgenciesAsync()
    {
        try
        {
            var allAgencies = await AgencyRepo.GetAllAsync();
            agencies = allAgencies.Where(a => a.IsActive).OrderBy(a => a.Name).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to load agencies. Please try again.";
        }
    }

    private async Task HandleSubmit()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            // Validate agency selection
            if (formModel.AgencyId <= 0)
            {
                errorMessage = "Please select an agency.";
                isLoading = false;
                return;
            }

            var selectedAgency = agencies.FirstOrDefault(a => a.Id == formModel.AgencyId);
            if (selectedAgency == null)
            {
                errorMessage = "Invalid agency selection.";
                isLoading = false;
                return;
            }

            // Validate 3-letter code
            if (string.IsNullOrWhiteSpace(formModel.ThreeLetterCode) || formModel.ThreeLetterCode.Length != 3)
            {
                errorMessage = "Please enter a valid 3-letter code.";
                isLoading = false;
                return;
            }

            if (!string.Equals(selectedAgency.ThreeLetterCode, formModel.ThreeLetterCode, StringComparison.OrdinalIgnoreCase))
            {
                errorMessage = "Invalid agency code. Please check your 3-letter code.";
                isLoading = false;
                return;
            }

            // Save to OrderStateService
            await OrderState.SetAgencyAsync(selectedAgency.Id, selectedAgency.Name, selectedAgency.ThreeLetterCode);

            // Navigate to next step
            Nav.NavigateTo("/shop/demographics");
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred. Please try again.";
            isLoading = false;
        }
    }

    private class AgencyFormModel
    {
        public int AgencyId { get; set; }
        public string ThreeLetterCode { get; set; } = string.Empty;
    }
}
