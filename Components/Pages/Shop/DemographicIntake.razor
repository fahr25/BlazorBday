@page "/shop/demographics"
@using BlazorBday.Services
@inject OrderStateService OrderState
@inject NavigationManager Nav
@rendermode InteractiveServer

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <StepIndicator CurrentStep="2" />

            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Tell Us About Your Child</h3>
                </div>
                <div class="card-body">
                    <p class="lead">We need your child's date of birth to calculate their shopping points.</p>
                    <p class="text-muted">No personal information is collected. We only use this to determine point allocation.</p>

                    <ErrorAlert ErrorMessage="@errorMessage" OnClear="@(() => errorMessage = null)" />

                    <div class="alert alert-info">
                        <strong>Points Allocation:</strong><br/>
                        Children ages 0-11: <strong>65 points</strong><br/>
                        Children ages 12-18: <strong>100 points</strong>
                    </div>

                    <EditForm Model="@formModel" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label for="childDateOfBirth" class="form-label">Child's Date of Birth</label>
                            <InputDate id="childDateOfBirth"
                                       @bind-Value="formModel.ChildDateOfBirth"
                                       class="form-control"
                                       max="@DateTime.Today.ToString("yyyy-MM-dd")"
                                       min="@DateTime.Today.AddYears(-18).ToString("yyyy-MM-dd")"
                                       required />
                            <small class="form-text text-muted">Child must be between 0 and 18 years old.</small>
                            <ValidationMessage For="@(() => formModel.ChildDateOfBirth)" />
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" disabled="@isLoading">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Calculate Points & Continue
                            </button>
                            <button type="button" class="btn btn-secondary" @onclick="GoBack">
                                Back
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private DemographicFormModel formModel = new();
    private string? errorMessage;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await OrderState.InitializeAsync();

        // Prerequisite check: Agency must be selected
        if (OrderState.AgencyId == null)
        {
            Nav.NavigateTo("/shop/agency");
            return;
        }

        // Pre-fill if already set
        if (OrderState.ChildDateOfBirth.HasValue)
        {
            formModel.ChildDateOfBirth = OrderState.ChildDateOfBirth.Value;
        }
        else
        {
            // Default to today's date for easier selection
            formModel.ChildDateOfBirth = DateTime.Today.AddYears(-5);
        }
    }

    private async Task HandleSubmit()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            // Calculate age
            var age = CalculateAge(formModel.ChildDateOfBirth);

            // Validate age range
            if (age < 0 || age > 18)
            {
                errorMessage = "Child must be between 0 and 18 years old.";
                isLoading = false;
                return;
            }

            // Save to OrderStateService
            await OrderState.SetChildInfoAsync(formModel.ChildDateOfBirth, age);

            // Navigate to next step
            Nav.NavigateTo("/shop/ready");
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred. Please try again.";
            isLoading = false;
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("/shop/agency");
    }

    private int CalculateAge(DateTime birthDate)
    {
        var today = DateTime.Today;
        var age = today.Year - birthDate.Year;

        // Adjust if birthday hasn't occurred yet this year
        if (birthDate.Date > today.AddYears(-age))
        {
            age--;
        }

        return age;
    }

    private class DemographicFormModel
    {
        public DateTime ChildDateOfBirth { get; set; } = DateTime.Today;
    }
}
